name: üîÅ Sync Org to Personal Repo (Fresh Push)

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout org repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper sync

      - name: üîß Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: üîç Debug GH_PAT presence
        run: echo "GH_PAT is ${{ secrets.GH_PAT && 'set' || 'not set' }}"

      - name: üöÄ Push to personal repo (Benjy0812/Gooble)
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # Verify PAT is available
          if [ -z "$GH_PAT" ]; then
            echo "üö® GH_PAT secret is not set!"
            exit 1
          fi
          
          # Debug: Show first few chars of PAT (safely)
          echo "PAT starts with: ${GH_PAT:0:4}..."
          
          # Completely reset git credentials
          git config --global --unset-all credential.helper || true
          git config --system --unset-all credential.helper || true
          git config --local --unset-all credential.helper || true
          
          # Remove any cached credentials
          rm -rf ~/.git-credentials ~/.gitconfig || true
          
          # Set up fresh git config with the PAT
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"
          git config --global credential.helper "store --file=/tmp/git-credentials"
          
          # Create credentials file with our PAT
          echo "https://${GH_PAT}@github.com" > /tmp/git-credentials
          
          # Ensure we're on main branch
          git checkout -B main
          
          # Test authentication first
          echo "üîç Testing authentication..."
          if ! git ls-remote https://github.com/Benjy0812/Gooble.git >/dev/null 2>&1; then
            echo "‚ùå Authentication test failed!"
            exit 1
          fi
          echo "‚úÖ Authentication test passed!"
          
          # Push with retry logic
          for i in 1 2 3; do
            echo "Attempt $i to push..."
            if git push https://github.com/Benjy0812/Gooble.git main --force; then
              echo "‚úÖ Successfully pushed to personal repo!"
              break
            else
              echo "‚ùå Push failed on attempt $i"
              if [ $i -eq 3 ]; then
                echo "üö® All push attempts failed!"
                exit 1
              fi
              echo "‚è≥ Retrying in 5 seconds..."
              sleep 5
            fi
          done