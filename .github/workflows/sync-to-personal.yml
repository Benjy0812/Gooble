name: 🔁 Sync Org to Personal Repo (Fresh Push)

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout org repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper sync

      - name: 🔧 Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: 🔍 Debug GH_PAT presence
        run: echo "GH_PAT is ${{ secrets.GH_PAT && 'set' || 'not set' }}"

      - name: 🚀 Push to personal repo using GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Verify PAT is available
          if [ -z "$GH_TOKEN" ]; then
            echo "🚨 GH_PAT secret is not set!"
            exit 1
          fi
          
          # Debug: Show first few chars of PAT (safely)
          echo "PAT starts with: ${GH_TOKEN:0:4}..."
          
          # Authenticate with GitHub CLI
          echo "🔐 Authenticating with GitHub CLI..."
          echo "$GH_TOKEN" | gh auth login --with-token
          
          # Verify authentication
          echo "🔍 Testing GitHub CLI authentication..."
          gh auth status
          
          # Clone the target repo to a temporary directory
          echo "📥 Cloning target repository..."
          gh repo clone Benjy0812/Gooble temp-repo
          
          # Copy all files from current repo to target repo (excluding .git)
          echo "📁 Copying files..."
          rsync -av --exclude='.git' ./ temp-repo/
          
          # Change to target repo directory
          cd temp-repo
          
          # Configure git for the commit
          git config user.name "GitHub Actions Sync"
          git config user.email "actions@github.com"
          
          # Add all changes
          git add .
          
          # Check if there are any changes to commit
          if git diff --staged --quiet; then
            echo "✅ No changes to sync - repositories are already in sync!"
          else
            # Commit changes
            echo "💾 Committing changes..."
            git commit -m "Sync from organization repository"
            
            # Push changes
            echo "🚀 Pushing to personal repository..."
            git push origin main
            
            echo "✅ Successfully synced to personal repository!"
          fi